#!/bin/sh
#
# git-vendor.sh: manage vendored repos via git-subtree
#
# Copyright (c) 2016 Brett Langdon <me@brett.is>
#
_usage()
{
    cat <<EOF
Usage:
  git vendor --help
  git vendor add [--prefix <dir>] <name> <repository> [<ref>]
  git vendor list [<name>]
  git vendor update <name> [<ref>]
EOF
}

PATH=$PATH:$(git --exec-path)
. git-sh-setup
require_work_tree

case "$1" in
    ""|"--help") _usage && exit ;;
esac

command="$1"
shift
case "$command" in
    "add"|"list"|"update") ;;
    *) >&2 echo "error: unknown command \"$command\"" && _usage && exit 1 ;;
esac

prefix="vendor"
if [ "$1" == "--prefix" ]; then
    prefix="$2"
    shift; shift
fi


vendor_names_from_log()
{
    name=
    git log --grep="^git-vendor-name: .*\$" \
	--pretty=format:'START %H%n%s%n%n%b%nEND%n' HEAD |
	while read a b junk; do
	    case "$a" in
		START) ;;
		git-vendor-name:) name="$b" ;;
		END)
                    echo "$name"
                    name=
                    ;;
	    esac
	done
}

cmd_add()
{
    name="$1"
    repository="$2"
    ref="master"
    if [ "$3" != "" ]; then
        ref="$3"
    fi
    if [ $# -lt 2 ];
    then
        die "Incorrect options provided: git vendor add <name> <repository> [<ref>]"
    fi

    dir="$prefix/$(echo "$repository" | sed -E 's/^[a-zA-Z]+((:\/\/)|@)//' | sed 's/:/\//' | sed -E 's/\.git$//')"
    message="\
Add \"$name\" from \"$repository@$ref\"

git-vendor-name: $name
git-vendor-dir: $dir
git-vendor-repository: $repository
git-vendor-ref: $ref
"
    set -x
    git subtree add --prefix "$dir" --message "$message" "$repository" "$ref" --squash
}

cmd_list()
{
    showOnly="$1"
    vendorNames=($(vendor_names_from_log | sort -u))
    for name in "${vendorNames[@]}";
    do
    git log -1 --grep="^git-vendor-name: $name\$" \
	--pretty=format:'START %H%n%s%n%n%b%nEND%n' HEAD |
	while read a b junk; do
	    case "$a" in
		START) commit="$b" ;;
                git-vendor-name:) name="$b" ;;
                git-vendor-dir:) dir="$b" ;;
                git-vendor-ref:) ref="$b" ;;
		git-vendor-repository:) repository="$b" ;;
		END)
                    if [[ ! -z "$repository" ]];
                    then
                        if [[ -z "$showOnly" ]] || [ "$showOnly" == "$name" ]; then
                            echo "$name@$ref:"
                            echo "\tname:\t$name"
                            echo "\tdir:\t$dir"
                            echo "\trepo:\t$repository"
                            echo "\tref:\t$ref"
                            echo "\tcommit:\t$commit"
                            echo ""
                        fi
                    fi
                    name=
                    dir=
                    ref=
                    commit=
                    repository=
                    ;;
	    esac
	done
    done;

}

cmd_update()
{
    name="$1"
    ref="master"
    if [ "$2" != "" ]; then
        ref="$2"
    fi
    if [ $# -lt 1 ]; then
        die "Incorrect options provided: git vendor update <name> [<ref>]"
    fi
    git log -1 --grep="^git-vendor-name: $name\$" \
	--pretty=format:'START %H%n%s%n%n%b%nEND%n' HEAD |
	while read a b junk; do
	    case "$a" in
		START) ;;
                git-vendor-dir:) dir="$b" ;;
		git-vendor-repository:) repository="$b" ;;
		END)
                    if [[ ! -z "$repository" ]];
                    then
                        message="\
Update \"$name\" from \"$repository@$ref\"

git-vendor-name: $name
git-vendor-dir: $dir
git-vendor-repository: $repository
git-vendor-ref: $ref
"
                        git subtree pull --prefix "$dir" --message "$message" "$repository" "$ref" --squash
                        break
                    fi
                    ;;
	    esac
	done
}

"cmd_$command" "$@"
